<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">ERP System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMain">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
                    <li class="nav-item"><a class="nav-link" href="admission.html">Admission</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Admin</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container my-4">

<h2 class="mb-3">ERP Login</h2>

<form id="loginForm" class="mx-auto" style="max-width:420px;">
    <div class="mb-3">
        <label class="form-label">Username</label>
        <input class="form-control" type="text" id="username" name="username" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Password</label>
        <input class="form-control" type="password" id="password" name="password" required>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Login</button>
        <a href="admission.html" class="btn btn-outline-secondary">Back</a>
    </div>
</form>

<p id="msg" class="mt-3"></p>

<p id="registerLink" class="text-center mt-3"></p>

<script>
document.getElementById("loginForm").onsubmit = function(e) {
    e.preventDefault();

    const username = document.getElementById("username");
    const password = document.getElementById("password");
    const msgEl = document.getElementById("msg");
    
    msgEl.innerText = "Logging in...";

    console.log("Login attempt:", {
        username: username.value,
        url: "http://127.0.0.1:5000/login",
        method: "POST"
    });

    fetch("http://127.0.0.1:5000/login", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `username=${encodeURIComponent(username.value)}&password=${encodeURIComponent(password.value)}`,
        credentials: "include"  // Important: send cookies with request
    })
    .then(res => {
        console.log("Response received:", res.status, res.statusText);
        if (!res.ok && res.status !== 401) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json().catch(err => {
            console.error('JSON parse failed:', err);
            throw new Error('Failed to parse login response');
        });
    })
    .then(data => {
        console.log("Login response:", data);
        if (data.status === "success") {
            // Store user info in localStorage for UI reference
            localStorage.setItem('current_user', JSON.stringify({
                role: data.role,
                user_id: data.user_id,
                username: username.value
            }));
            
            if (data.role === "admin") {
                msgEl.innerText = "Success! Redirecting to admin dashboard...";
                window.location.href = "dashboard.html";
            } else if (data.role === "student") {
                msgEl.innerText = "Success! Redirecting to student dashboard...";
                window.location.href = "student_dashboard.html?student_id=" + data.user_id;
            } else {
                msgEl.innerText = "Unknown role: " + data.role;
            }
        } else {
            msgEl.innerText = data.message || "Invalid login credentials!";
            // Show registration link for students (numeric username)
            const reg = document.getElementById('registerLink');
            if (/^\d+$/.test(username.value)) {
                reg.innerHTML = `Not registered? <a href="student_register.html?student_id=${encodeURIComponent(username.value)}">Register here</a>`;
            } else {
                reg.innerHTML = `If you're a student, <a href="student_register.html">register here</a>`;
            }
        }
    })
    .catch(err => {
        const errMsg = err.message || 'Network error';
        msgEl.innerText = "Server error: " + errMsg + " (Check browser console with F12)";
        console.error('Login error details:', {
            error: err,
            message: err.message,
            stack: err.stack,
            backend_url: "http://127.0.0.1:5000",
            frontend_origin: window.location.origin
        });
    });
};
</script>
</script>


</body>
</div>
</body>
</html>
