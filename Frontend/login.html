<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
        <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <div class="container nav">
        <strong>ERP System</strong>
        <nav style="margin-left:18px">
            <a href="login.html">Login</a>
            <a href="admission.html">Admission</a>
            <a href="dashboard.html">Admin</a>
        </nav>
    </div>
</header>

<div class="container">

<h2>ERP Login</h2>

<form id="loginForm">
    Username:<br>
    <input type="text" id="username" name="username" required><br><br>

    Password:<br>
    <input type="password" id="password" name="password" required><br><br>

    <button type="submit">Login</button>
</form>

<p id="msg"></p>

<p id="registerLink" style="margin-top:8px"></p>

<script>
document.getElementById("loginForm").onsubmit = function(e) {
    e.preventDefault();

    const username = document.getElementById("username");
    const password = document.getElementById("password");
    const msgEl = document.getElementById("msg");
    
    msgEl.innerText = "Logging in...";

    console.log("Login attempt:", {
        username: username.value,
        url: "http://127.0.0.1:5000/login",
        method: "POST"
    });

    fetch("http://127.0.0.1:5000/login", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `username=${encodeURIComponent(username.value)}&password=${encodeURIComponent(password.value)}`,
        credentials: "include"  // Important: send cookies with request
    })
    .then(res => {
        console.log("Response received:", res.status, res.statusText);
        if (!res.ok && res.status !== 401) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json().catch(err => {
            console.error('JSON parse failed:', err);
            throw new Error('Failed to parse login response');
        });
    })
    .then(data => {
        console.log("Login response:", data);
        if (data.status === "success") {
            // Store user info in localStorage for UI reference
            localStorage.setItem('current_user', JSON.stringify({
                role: data.role,
                user_id: data.user_id,
                username: username.value
            }));
            
            if (data.role === "admin") {
                msgEl.innerText = "Success! Redirecting to admin dashboard...";
                window.location.href = "dashboard.html";
            } else if (data.role === "student") {
                msgEl.innerText = "Success! Redirecting to student dashboard...";
                window.location.href = "student_dashboard.html?student_id=" + data.user_id;
            } else {
                msgEl.innerText = "Unknown role: " + data.role;
            }
        } else {
            msgEl.innerText = data.message || "Invalid login credentials!";
            // Show registration link for students (numeric username)
            const reg = document.getElementById('registerLink');
            if (/^\d+$/.test(username.value)) {
                reg.innerHTML = `Not registered? <a href="student_register.html?student_id=${encodeURIComponent(username.value)}">Register here</a>`;
            } else {
                reg.innerHTML = `If you're a student, <a href="student_register.html">register here</a>`;
            }
        }
    })
    .catch(err => {
        const errMsg = err.message || 'Network error';
        msgEl.innerText = "Server error: " + errMsg + " (Check browser console with F12)";
        console.error('Login error details:', {
            error: err,
            message: err.message,
            stack: err.stack,
            backend_url: "http://127.0.0.1:5000",
            frontend_origin: window.location.origin
        });
    });
};
</script>
</script>


</body>
</div>
</body>
</html>
